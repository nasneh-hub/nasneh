# PR Size Check Workflow
# Warns when PRs are too large and encourages smaller, focused PRs
# Best practice: PRs should be <500 lines for easier review

name: PR Size Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  size-check:
    name: Check PR Size
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate PR size
        id: size
        run: |
          # Get the diff stats
          git fetch origin ${{ github.base_ref }}
          
          # Calculate additions and deletions (excluding lock files)
          STATS=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | \
            grep -v "pnpm-lock.yaml" | \
            grep -v "package-lock.json" | \
            grep -v "yarn.lock" | \
            grep -v ".snap" | \
            awk '{ added += $1; deleted += $2 } END { print added, deleted }')
          
          ADDED=$(echo $STATS | cut -d' ' -f1)
          DELETED=$(echo $STATS | cut -d' ' -f2)
          TOTAL=$((ADDED + DELETED))
          
          echo "added=$ADDED" >> $GITHUB_OUTPUT
          echo "deleted=$DELETED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          
          # Determine size category
          if [ $TOTAL -le 10 ]; then
            echo "category=XS" >> $GITHUB_OUTPUT
            echo "emoji=ðŸŸ¢" >> $GITHUB_OUTPUT
          elif [ $TOTAL -le 100 ]; then
            echo "category=S" >> $GITHUB_OUTPUT
            echo "emoji=ðŸŸ¢" >> $GITHUB_OUTPUT
          elif [ $TOTAL -le 500 ]; then
            echo "category=M" >> $GITHUB_OUTPUT
            echo "emoji=ðŸŸ¡" >> $GITHUB_OUTPUT
          elif [ $TOTAL -le 1000 ]; then
            echo "category=L" >> $GITHUB_OUTPUT
            echo "emoji=ðŸŸ " >> $GITHUB_OUTPUT
          else
            echo "category=XL" >> $GITHUB_OUTPUT
            echo "emoji=ðŸ”´" >> $GITHUB_OUTPUT
          fi
          
          echo "PR Size: $TOTAL lines (+$ADDED/-$DELETED)"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const added = ${{ steps.size.outputs.added }};
            const deleted = ${{ steps.size.outputs.deleted }};
            const total = ${{ steps.size.outputs.total }};
            const category = '${{ steps.size.outputs.category }}';
            const emoji = '${{ steps.size.outputs.emoji }}';
            
            let message = `## ${emoji} PR Size: **${category}** (${total} lines)\n\n`;
            message += `| Metric | Count |\n`;
            message += `|--------|-------|\n`;
            message += `| âž• Additions | ${added} |\n`;
            message += `| âž– Deletions | ${deleted} |\n`;
            message += `| ðŸ“Š Total | ${total} |\n\n`;
            
            if (category === 'XL') {
              message += `### âš ï¸ Large PR Warning\n\n`;
              message += `This PR is quite large (>1000 lines). Consider:\n`;
              message += `- Breaking it into smaller, focused PRs\n`;
              message += `- Each PR should do one thing well\n`;
              message += `- Smaller PRs are easier to review and less risky\n\n`;
              message += `> ðŸ’¡ **Tip:** Aim for PRs under 500 lines for faster reviews.\n`;
            } else if (category === 'L') {
              message += `### ðŸ“ Note\n\n`;
              message += `This PR is on the larger side. If possible, consider breaking it up in the future.\n`;
            } else {
              message += `âœ… Great job keeping this PR focused and reviewable!\n`;
            }
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Size:')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: message
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });
            }

      - name: Fail if XL (optional - currently disabled)
        if: false  # Set to true to block XL PRs
        run: |
          if [ "${{ steps.size.outputs.category }}" = "XL" ]; then
            echo "::error::PR is too large (>1000 lines). Please break it into smaller PRs."
            exit 1
          fi
