name: ğŸš¨ UI Law Enforcement

on:
  pull_request:
    paths:
      - 'apps/customer-web/**/*.tsx'
      - 'apps/customer-web/**/*.ts'
      - 'apps/dashboard/**/*.tsx'
      - 'apps/dashboard/**/*.ts'
      - 'packages/ui/src/**/*.tsx'
      - 'packages/ui/src/**/*.ts'

# Define frontend paths as environment variable for reuse
env:
  FRONTEND_PATHS: 'packages/ui/src apps/customer-web apps/dashboard'

jobs:
  ui-law-check:
    name: UI Law Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: 'Law 3: Check for Hex Colors'
        id: check-hex-colors
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for hex colors (#FFFFFF, #000, etc.)..."
          
          # Search for hex colors in frontend code only (not in comments or tokens.css)
          VIOLATIONS=$(grep -r -n -E '#[0-9A-Fa-f]{3,8}' \
            --include="*.tsx" --include="*.ts" \
            packages/ui/src apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v -E '(//|/\*|\*)' \
            | grep -v 'tokens.css' \
            | grep -v 'node_modules' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ VIOLATION: Hex colors found"
            echo ""
            echo "Hex colors are forbidden. Use CSS variables from tokens.css instead."
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/UI_LAW.md - Law #3"
            echo ""
            echo "âœ… Correct: var(--text-primary)"
            echo "âŒ Wrong: #000000"
            exit 1
          else
            echo "âœ… PASS: No hex colors found"
          fi

      - name: 'Law 3: Check for Tailwind Color Classes'
        id: check-tailwind-colors
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for Tailwind color classes (bg-white, text-black, etc.)..."
          
          # Search for Tailwind color classes in frontend code only
          VIOLATIONS=$(grep -r -n -E '(bg|text|border)-(white|black|gray|red|blue|green|yellow|purple|pink|indigo|orange)-[0-9]{2,3}' \
            --include="*.tsx" --include="*.ts" \
            packages/ui/src apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v 'node_modules' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ VIOLATION: Tailwind color classes found"
            echo ""
            echo "Tailwind color classes are forbidden. Use CSS variables from tokens.css instead."
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/UI_LAW.md - Law #3"
            echo ""
            echo "âœ… Correct: var(--bg-primary)"
            echo "âŒ Wrong: bg-gray-100"
            exit 1
          else
            echo "âœ… PASS: No Tailwind color classes found"
          fi

      - name: 'Law 3: Check for Inline Styles'
        id: check-inline-styles
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for inline styles (style={{...}})..."
          
          # Search for inline styles in frontend code only
          VIOLATIONS=$(grep -r -n -E 'style=\{\{' \
            --include="*.tsx" --include="*.ts" \
            packages/ui/src apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v 'node_modules' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ VIOLATION: Inline styles found"
            echo ""
            echo "Inline styles are forbidden. Use CSS classes with tokens.css variables."
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/UI_LAW.md - Law #3"
            echo ""
            echo "âœ… Correct: className=\"text-primary\""
            echo "âŒ Wrong: style={{ color: '#000' }}"
            exit 1
          else
            echo "âœ… PASS: No inline styles found"
          fi

      - name: 'Law 1: Check for Border Classes'
        id: check-borders
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for border classes (border-*, border, etc.)..."
          
          # Search for border Tailwind classes in tsx/ts files only (not CSS)
          # Exclude border-box (valid CSS property) and comments
          VIOLATIONS=$(grep -r -n -E '\bborder(-[a-z0-9]+)?\b' \
            --include="*.tsx" --include="*.ts" \
            packages/ui/src apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v 'border-box' \
            | grep -v 'border-radius' \
            | grep -v 'node_modules' \
            | grep -v -E '(//|/\*|\*)' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ VIOLATION: Border classes found"
            echo ""
            echo "Borders are FORBIDDEN. Use backgrounds, shadows, or spacing instead."
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/UI_LAW.md - Law #1"
            echo ""
            echo "âœ… Correct: bg-tertiary shadow-sm"
            echo "âŒ Wrong: border border-gray-300"
            exit 1
          else
            echo "âœ… PASS: No border classes found"
          fi

      - name: 'Law 2: Check for Invalid Border Radius'
        id: check-border-radius
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for invalid border radius (only rounded-xl and rounded-full allowed)..."
          
          # Search for invalid rounded classes in tsx/ts files only (not CSS or tokens.css)
          VIOLATIONS=$(grep -r -n -E 'rounded-(none|sm|md|lg|2xl|3xl)' \
            --include="*.tsx" --include="*.ts" \
            packages/ui/src apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v 'node_modules' \
            | grep -v -E '(//|/\*|\*)' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ VIOLATION: Invalid border radius found"
            echo ""
            echo "Only rounded-xl (standard) and rounded-full (icon buttons/avatar) are allowed."
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/UI_LAW.md - Law #2"
            echo ""
            echo "âœ… Correct: rounded-xl (standard), rounded-full (icon buttons)"
            echo "âŒ Wrong: rounded-sm, rounded-md, rounded-lg"
            exit 1
          else
            echo "âœ… PASS: Only valid border radius found"
          fi

      - name: 'Brand Voice: Forbidden Terminology Check'
        id: check-forbidden-terms
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for forbidden terminology..."
          
          # Search for forbidden terms ONLY in UI copy files and frontend apps
          # Exclude backend API (apps/api) entirely
          # Note: Using word boundaries (\b) to prevent false positives like 'localStorage'
          VIOLATIONS=$(grep -r -n -E '(Ø²Ø¨ÙˆÙ†|Ø¨Ø§Ø¦Ø¹|Ù…Ø­Ù„ÙŠ|Ø±Ø®ÙŠØµ|\bcustomer\b|\bbuyer\b|\bseller\b|\bvendor\b|\bmerchant\b|\bcheap\b|\bbudget\b|\blocal\b)' \
            --include="*.tsx" --include="*.ts" \
            packages/ui/src apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v '/copy/' \
            | grep -v 'terminology.ts' \
            | grep -v 'node_modules' \
            | grep -v -E '(//|/\*|\*)' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ VIOLATION: Forbidden terminology found"
            echo ""
            echo "These terms are forbidden:"
            echo "  Arabic: Ø²Ø¨ÙˆÙ†ØŒ Ø¨Ø§Ø¦Ø¹ØŒ Ù…Ø­Ù„ÙŠØŒ Ø±Ø®ÙŠØµ"
            echo "  English: customer, buyer, seller, vendor, merchant, cheap, budget, local"
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/BRAND_VOICE.md - Section 4"
            echo ""
            echo "âœ… Correct: Use copy tokens (ar.ui.supporter, ar.ui.nasneh)"
            echo "âŒ Wrong: Hardcoded forbidden terms"
            exit 1
          else
            echo "âœ… PASS: No forbidden terminology found"
          fi

      - name: 'Copy Tokens: Check for Hardcoded Arabic Text'
        id: check-hardcoded-arabic
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for hardcoded Arabic text..."
          
          # Search for Arabic text in frontend code only (excluding copy tokens and comments)
          VIOLATIONS=$(grep -r -n -P '[\p{Arabic}]+' \
            --include="*.tsx" --include="*.ts" \
            packages/ui/src apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v '/copy/' \
            | grep -v 'terminology.ts' \
            | grep -v 'BRAND_VOICE.md' \
            | grep -v 'node_modules' \
            | grep -v -E '(//|/\*|\*)' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ VIOLATION: Hardcoded Arabic text found"
            echo ""
            echo "All Arabic text must come from copy tokens (ar.ts)."
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/BRAND_VOICE.md - Section 12"
            echo ""
            echo "âœ… Correct: {ar.ui.welcome}"
            echo "âŒ Wrong: \"Ù…Ø±Ø­Ø¨Ø§Ù‹\""
            exit 1
          else
            echo "âœ… PASS: No hardcoded Arabic text found"
          fi

      - name: 'Copy Tokens: Check for Common Hardcoded English'
        id: check-hardcoded-english
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for common hardcoded English UI text..."
          
          # Search for common UI text in frontend code only (warning only)
          VIOLATIONS=$(grep -r -n -E '("(Save|Delete|Edit|Cancel|Submit|Confirm|Back|Next|Loading|Error|Success|Welcome|Login|Logout|Profile|Settings|Search|Filter|Sort|View|Add|Remove|Update|Create)"|>(Save|Delete|Edit|Cancel|Submit|Confirm|Back|Next|Loading|Error|Success|Welcome|Login|Logout|Profile|Settings|Search|Filter|Sort|View|Add|Remove|Update|Create)<)' \
            --include="*.tsx" --include="*.ts" \
            packages/ui/src apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v '/copy/' \
            | grep -v 'node_modules' \
            | grep -v -E '(//|/\*|\*)' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âš ï¸ WARNING: Common hardcoded English UI text found"
            echo ""
            echo "Consider using copy tokens for better i18n support."
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/BRAND_VOICE.md - Section 12"
            echo ""
            echo "âœ… Recommended: {en.ui.save}"
            echo "âš ï¸ Found: \"Save\""
            echo ""
            echo "Note: This is a warning only, not blocking."
          else
            echo "âœ… PASS: No common hardcoded English found"
          fi

      - name: 'Law 4: Check for Non-Vazirmatn Fonts'
        id: check-font-family
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for non-Vazirmatn fonts..."
          
          # Search for fontFamily in frontend code only that's not Vazirmatn or var(--font)
          VIOLATIONS=$(grep -r -n -E "fontFamily.*['\"](?!Vazirmatn|var\(--font)" \
            --include="*.tsx" --include="*.ts" \
            packages/ui/src apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v 'node_modules' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ VIOLATION: Non-Vazirmatn fonts found"
            echo ""
            echo "Only Vazirmatn font is allowed."
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/UI_LAW.md - Law #4"
            echo ""
            echo "âœ… Correct: fontFamily: 'var(--font-family-primary)'"
            echo "âŒ Wrong: fontFamily: 'Arial'"
            exit 1
          else
            echo "âœ… PASS: Only Vazirmatn font found"
          fi

      - name: 'Law 5: Check for External UI Libraries'
        id: check-external-libs
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for external UI library imports..."
          
          # Search for imports from external UI libraries in frontend code only
          VIOLATIONS=$(grep -r -n -E "from ['\"](@mui|antd|react-bootstrap|chakra-ui|mantine|shadcn|@radix-ui|@headlessui)" \
            --include="*.tsx" --include="*.ts" \
            packages/ui/src apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v 'node_modules' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ VIOLATION: External UI library imports found"
            echo ""
            echo "Only @nasneh/ui components are allowed."
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/UI_LAW.md - Law #5"
            echo ""
            echo "âœ… Correct: import { Button } from '@nasneh/ui'"
            echo "âŒ Wrong: import { Button } from 'antd'"
            exit 1
          else
            echo "âœ… PASS: Only @nasneh/ui components imported"
          fi

      - name: 'Design System: Check for Hardcoded CSS Values'
        id: check-css-tokens
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for hardcoded CSS values..."
          
          # This check is a warning only, skip CSS files entirely
          # Only check tsx/ts files for inline hardcoded values
          VIOLATIONS=$(grep -r -n -E "(height|padding|margin|fontSize|borderRadius):\s*['\"]?[0-9]+(px|rem|em)" \
            --include="*.tsx" --include="*.ts" \
            packages/ui/src apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v 'node_modules' \
            | grep -v -E '(//|/\*|\*)' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âš ï¸ WARNING: Hardcoded CSS values found"
            echo ""
            echo "Consider using CSS variables from tokens.css for consistency."
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: packages/ui/src/styles/tokens.css"
            echo ""
            echo "âœ… Recommended: height: var(--height-md)"
            echo "âš ï¸ Found: height: 48px"
            echo ""
            echo "Note: This is a warning only, not blocking."
          else
            echo "âœ… PASS: CSS variables used consistently"
          fi

      - name: 'Law 5: Check for className Prop on @nasneh/ui Components'
        id: check-classname-prop
        continue-on-error: true
        run: |
          echo "ğŸ” Checking for className prop on @nasneh/ui components..."
          
          # Search for className on UI components in consumer apps only (not in component definitions)
          # Only check apps, not packages/ui/src (where components are defined)
          # Note: Using word boundary (\b) after component name to prevent matching CardContent, CardHeader, etc.
          VIOLATIONS=$(grep -r -n -E "<(Button|Input|Card|Badge|Dialog|SegmentedControl|Table|Select|Tabs|Avatar|Toast|Skeleton)\b[^>]*className=" \
            --include="*.tsx" \
            apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v 'node_modules' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ VIOLATION: className prop found on @nasneh/ui components"
            echo ""
            echo "className prop is not allowed on @nasneh/ui components to prevent style overrides."
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/UI_LAW.md - Law #5"
            echo "ğŸ“– See: docs/SPECS/COMPONENT_SPECS.md - Props Interface"
            echo ""
            echo "âœ… Correct: <Button variant=\"primary\">Click</Button>"
            echo "âŒ Wrong: <Button className=\"my-styles\">Click</Button>"
            exit 1
          else
            echo "âœ… PASS: No className prop on @nasneh/ui components"
          fi

      - name: 'Summary: UI Law Compliance Report'
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš¨ UI LAW ENFORCEMENT SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Scan scope: Frontend only"
          echo "  - packages/ui/src/**/*.{ts,tsx}"
          echo "  - apps/customer-web/**/*.{ts,tsx}"
          echo "  - apps/dashboard/**/*.{ts,tsx}"
          echo ""
          echo "Excluded:"
          echo "  - apps/api/** (backend)"
          echo "  - *.css files (use tokens.css)"
          echo "  - docs/**"
          echo ""
          echo "Checks performed:"
          echo ""
          echo "  1. âœ“ Hex Colors (Law #3)"
          echo "  2. âœ“ Tailwind Color Classes (Law #3)"
          echo "  3. âœ“ Inline Styles (Law #3)"
          echo "  4. âœ“ Border Classes (Law #1)"
          echo "  5. âœ“ Invalid Border Radius (Law #2)"
          echo "  6. âœ“ Forbidden Terminology (Brand Voice)"
          echo "  7. âœ“ Hardcoded Arabic Text (Copy Tokens)"
          echo "  8. âœ“ Hardcoded English Text (Copy Tokens) [Warning]"
          echo "  9. âœ“ Non-Vazirmatn Fonts (Law #4)"
          echo " 10. âœ“ External UI Libraries (Law #5)"
          echo " 11. âœ“ Hardcoded CSS Values (Design System) [Warning]"
          echo " 12. âœ“ className Prop on UI Components (Law #5)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“– Documentation:"
          echo "  - UI Law: docs/SPECS/UI_LAW.md"
          echo "  - Brand Voice: docs/SPECS/BRAND_VOICE.md"
          echo "  - Component Specs: docs/SPECS/COMPONENT_SPECS.md"
          echo "  - Design Tokens: packages/ui/src/styles/tokens.css"
          echo "  - Copy Tokens: packages/ui/src/copy/"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Check if any critical checks failed
          if [ "${{ steps.check-hex-colors.outcome }}" == "failure" ] || \
             [ "${{ steps.check-tailwind-colors.outcome }}" == "failure" ] || \
             [ "${{ steps.check-inline-styles.outcome }}" == "failure" ] || \
             [ "${{ steps.check-borders.outcome }}" == "failure" ] || \
             [ "${{ steps.check-border-radius.outcome }}" == "failure" ] || \
             [ "${{ steps.check-forbidden-terms.outcome }}" == "failure" ] || \
             [ "${{ steps.check-hardcoded-arabic.outcome }}" == "failure" ] || \
             [ "${{ steps.check-font-family.outcome }}" == "failure" ] || \
             [ "${{ steps.check-external-libs.outcome }}" == "failure" ] || \
             [ "${{ steps.check-classname-prop.outcome }}" == "failure" ]; then
            echo "âŒ UI LAW VIOLATIONS DETECTED"
            echo ""
            echo "This PR cannot be merged until all violations are fixed."
            echo ""
            exit 1
          else
            echo "âœ… ALL CHECKS PASSED"
            echo ""
            echo "This PR complies with all UI Laws and Design System rules."
            echo ""
          fi
