name: ğŸš¨ UI Law Enforcement

on:
  pull_request:
    paths:
      - 'apps/customer-web/**/*.tsx'
      - 'apps/customer-web/**/*.ts'
      - 'apps/dashboard/**/*.tsx'
      - 'apps/dashboard/**/*.ts'
      - 'packages/ui/src/**/*.tsx'
      - 'packages/ui/src/**/*.ts'
      - 'apps/**/.env*'
      - '.github/workflows/ui-lint.yml'

# Define frontend paths as environment variable for reuse
env:
  FRONTEND_PATHS: 'packages/ui/src apps/customer-web apps/dashboard'

jobs:
  ui-law-check:
    name: UI Law Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: 'Check #1: Hex Colors (Except tokens.css)'
        id: check-hex-colors
        continue-on-error: true
        run: |
          echo "ğŸ” Check #1: Scanning for hex colors (except tokens.css)..."
          echo ""
          echo "Rule: NO hex colors anywhere except packages/ui/src/styles/tokens.css"
          echo "Pattern: #([0-9a-fA-F]{3,8})"
          echo ""
          
          # Search for hex colors in frontend code (exclude tokens.css)
          VIOLATIONS=$(grep -r -n -E '#[0-9A-Fa-f]{3,8}' \
            --include="*.tsx" --include="*.ts" \
            packages/ui/src apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v 'tokens.css' \
            | grep -v 'node_modules' \
            | grep -v -E '(//|/\*|\*)' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ VIOLATION: Hex colors found"
            echo ""
            echo "Hex colors are forbidden outside tokens.css."
            echo "Use shadcn semantic classes instead (bg-background, text-foreground, etc.)"
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/UI_LAW.md - Check #1"
            echo ""
            echo "âœ… Correct: className=\"text-foreground\""
            echo "âŒ Wrong: style={{ color: '#000' }}"
            exit 1
          else
            echo "âœ… PASS: No hex colors found outside tokens.css"
          fi

      - name: 'Check #2: Tailwind Palette Colors'
        id: check-tailwind-palette
        continue-on-error: true
        run: |
          echo "ğŸ” Check #2: Scanning for Tailwind palette colors..."
          echo ""
          echo "Rule: NO Tailwind color palette classes (bg-slate-*, text-gray-*, etc.)"
          echo "Pattern: (bg|text|border|ring)-(slate|gray|zinc|neutral|stone|red|orange|amber|yellow|lime|green|emerald|teal|cyan|sky|blue|indigo|violet|purple|fuchsia|pink|rose)-[0-9]{2,3}"
          echo ""
          
          # Search for Tailwind palette color classes in frontend code
          VIOLATIONS=$(grep -r -n -E '\b(bg|text|border|ring)-(slate|gray|zinc|neutral|stone|red|orange|amber|yellow|lime|green|emerald|teal|cyan|sky|blue|indigo|violet|purple|fuchsia|pink|rose)-[0-9]{2,3}\b' \
            --include="*.tsx" --include="*.ts" \
            packages/ui/src apps/customer-web apps/dashboard 2>/dev/null \
            | grep -v 'node_modules' \
            | grep -v -E '(//|/\*|\*)' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ VIOLATION: Tailwind palette colors found"
            echo ""
            echo "Tailwind color palette classes are forbidden."
            echo "Use shadcn semantic classes instead (bg-primary, text-muted, etc.)"
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/UI_LAW.md - Check #2"
            echo ""
            echo "âœ… Correct: className=\"bg-primary\""
            echo "âŒ Wrong: className=\"bg-blue-500\""
            exit 1
          else
            echo "âœ… PASS: No Tailwind palette colors found"
          fi

      - name: 'Check #3: No Localhost in Staging/Prod'
        id: check-localhost
        continue-on-error: true
        run: |
          echo "ğŸ” Check #3: Scanning for localhost in NEXT_PUBLIC_* env vars..."
          echo ""
          echo "Rule: NO localhost in any NEXT_PUBLIC_* environment variables"
          echo "Pattern: NEXT_PUBLIC_.*localhost"
          echo ""
          
          # Search for localhost in .env files (exclude .env.local, .env.development, and .env.example)
          VIOLATIONS=$(grep -r -n -E 'NEXT_PUBLIC_.*localhost' \
            --include=".env*" \
            apps/ 2>/dev/null \
            | grep -v '.env.local' \
            | grep -v '.env.development' \
            | grep -v '.env.example' || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "âŒ VIOLATION: localhost found in NEXT_PUBLIC_* env vars"
            echo ""
            echo "Localhost is forbidden in staging/production environment variables."
            echo "Use proper domain names instead."
            echo ""
            echo "Violations:"
            echo "$VIOLATIONS"
            echo ""
            echo "ğŸ“– See: docs/SPECS/UI_LAW.md - Check #3"
            echo ""
            echo "âœ… Correct: NEXT_PUBLIC_API_URL=https://api.nasneh.com"
            echo "âŒ Wrong: NEXT_PUBLIC_API_URL=http://localhost:3000"
            exit 1
          else
            echo "âœ… PASS: No localhost found in NEXT_PUBLIC_* env vars"
          fi

      - name: 'Summary: UI Law Compliance Report'
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš¨ UI LAW ENFORCEMENT (v2.0 - Shadcn-First)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Scope:"
          echo "  - packages/ui/src/**/*.{ts,tsx}"
          echo "  - apps/customer-web/**/*.{ts,tsx}"
          echo "  - apps/dashboard/**/*.{ts,tsx}"
          echo "  - apps/**/.env*"
          echo ""
          echo "Checks performed:"
          echo ""
          echo "  1. âœ“ Hex Colors (except tokens.css)"
          echo "  2. âœ“ Tailwind Palette Colors"
          echo "  3. âœ“ No Localhost in Staging/Prod"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“– Documentation:"
          echo "  - UI Law: docs/SPECS/UI_LAW.md (v2.0)"
          echo "  - Design Tokens: packages/ui/src/styles/tokens.css"
          echo ""
          echo "ğŸ¨ Shadcn-First Policy:"
          echo "  - âœ… Use shadcn semantic classes (bg-background, text-foreground, etc.)"
          echo "  - âœ… Use Tailwind for layout (flex, grid, gap-*, p-*, rounded-*, etc.)"
          echo "  - âŒ NO hex colors outside tokens.css"
          echo "  - âŒ NO Tailwind palette colors (bg-slate-*, text-gray-*, etc.)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Check if any step failed
          if [ "${{ steps.check-hex-colors.outcome }}" == "failure" ] || \
             [ "${{ steps.check-tailwind-palette.outcome }}" == "failure" ] || \
             [ "${{ steps.check-localhost.outcome }}" == "failure" ]; then
            echo "âŒ UI LAW VIOLATIONS DETECTED"
            echo ""
            echo "This PR cannot be merged until all violations are fixed."
            echo ""
            exit 1
          else
            echo "âœ… ALL CHECKS PASSED"
            echo ""
            echo "No UI Law violations detected. PR is ready for review."
            echo ""
          fi
