// Nasneh API - Prisma Schema
// Following TECHNICAL_SPEC.md data models
// Currency: BHD (3 decimal places)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ===========================================
// Enums
// ===========================================

enum UserRole {
  CUSTOMER
  VENDOR
  PROVIDER
  DRIVER
  ADMIN
}

enum UserStatus {
  BASIC
  VERIFIED
  SUSPENDED
}

enum VendorCategory {
  HOME_KITCHEN
  CRAFTS
  MARKET
  FOOD_TRUCK
}

enum VendorStatus {
  PENDING
  APPROVED
  ACTIVE
  SUSPENDED
}

enum SubscriptionPlan {
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  DELETED
}

// ===========================================
// Service Provider Enums
// ===========================================

enum ProviderCategory {
  HOME        // Home services (cleaning, repairs, etc.)
  PERSONAL    // Personal services (beauty, fitness, etc.)
  PROFESSIONAL // Professional services (consulting, etc.)
}

enum ProviderStatus {
  PENDING
  APPROVED
  ACTIVE
  SUSPENDED
}

enum ServiceType {
  APPOINTMENT     // Time-based appointments
  DELIVERY_DATE   // Service delivered on specific date
  PICKUP_DROPOFF  // Customer drops off, picks up later
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
  DELETED
}

// ===========================================
// Users
// ===========================================

model User {
  id            String     @id @default(uuid())
  phone         String     @unique
  name          String?
  email         String?    @unique
  avatarUrl     String?    @map("avatar_url")
  role          UserRole   @default(CUSTOMER)
  status        UserStatus @default(BASIC)
  preferredLang String     @default("en") @map("preferred_lang")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  vendor        Vendor?
  provider      ServiceProvider?
  addresses     Address[]
  customerOrders Order[]  @relation("CustomerOrders")
  driverOrders   Order[]  @relation("DriverOrders")
  auditLogs      AuditLog[]
  refundsCreated Refund[]
  customerBookings Booking[] @relation("CustomerBookings")

  @@map("users")
}

model Address {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  label       String   // e.g., "Home", "Work"
  addressLine String   @map("address_line")
  area        String
  block       String?
  road        String?
  building    String?
  floor       String?
  apartment   String?
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

// ===========================================
// Vendors & Stores
// ===========================================

model Vendor {
  id                    String           @id @default(uuid())
  userId                String           @unique @map("user_id")
  storeName             String           @map("store_name")
  storeDescription      String?          @map("store_description") @db.Text
  logoUrl               String?          @map("logo_url")
  category              VendorCategory
  subscriptionPlan      SubscriptionPlan @default(BASIC) @map("subscription_plan")
  subscriptionExpiresAt DateTime?        @map("subscription_expires_at")
  commissionRate        Decimal          @default(15.000) @map("commission_rate") @db.Decimal(5, 3)
  status                VendorStatus     @default(PENDING)
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  // Relations
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  products              Product[]
  orders                Order[]

  @@map("vendors")
}

// ===========================================
// Service Providers
// ===========================================

model ServiceProvider {
  id                    String           @id @default(uuid())
  userId                String           @unique @map("user_id")
  businessName          String           @map("business_name")
  description           String?          @db.Text
  logoUrl               String?          @map("logo_url")
  category              ProviderCategory
  subscriptionPlan      SubscriptionPlan @default(BASIC) @map("subscription_plan")
  subscriptionExpiresAt DateTime?        @map("subscription_expires_at")
  commissionRate        Decimal          @default(15.000) @map("commission_rate") @db.Decimal(5, 3)
  status                ProviderStatus   @default(PENDING)
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  // Relations
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  services              Service[]
  bookings              Booking[]

  @@map("service_providers")
}

// ===========================================
// Categories
// ===========================================

model Category {
  id          String     @id @default(uuid())
  name        String
  nameAr      String?    @map("name_ar")
  slug        String     @unique
  description String?    @db.Text
  imageUrl    String?    @map("image_url")
  parentId    String?    @map("parent_id")
  sortOrder   Int        @default(0) @map("sort_order")
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  // Self-relation for subcategories
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  // Relations
  products    Product[]
  services    Service[]

  @@map("categories")
}

// ===========================================
// Products
// ===========================================

model Product {
  id          String        @id @default(uuid())
  vendorId    String        @map("vendor_id")
  categoryId  String?       @map("category_id")
  name        String
  nameAr      String?       @map("name_ar")
  description String?       @db.Text
  descriptionAr String?     @map("description_ar") @db.Text
  price       Decimal       @db.Decimal(10, 3) // BHD 3 decimals
  images      Json          @default("[]") // Array of image URLs
  isAvailable Boolean       @default(true) @map("is_available")
  status      ProductStatus @default(ACTIVE)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  vendor      Vendor        @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  category    Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  orderItems  OrderItem[]

  @@index([vendorId])
  @@index([categoryId])
  @@index([status, isAvailable])
  @@map("products")
}

// ===========================================
// Services
// ===========================================

model Service {
  id              String        @id @default(uuid())
  providerId      String        @map("provider_id")
  categoryId      String?       @map("category_id")
  name            String
  nameAr          String?       @map("name_ar")
  description     String?       @db.Text
  descriptionAr   String?       @map("description_ar") @db.Text
  price           Decimal       @db.Decimal(10, 3) // BHD 3 decimals
  serviceType     ServiceType   @map("service_type")
  // For appointment type
  durationMinutes Int?          @map("duration_minutes")
  // For delivery_date type
  preparationDays Int?          @map("preparation_days")
  images          Json          @default("[]") // Array of image URLs
  isAvailable     Boolean       @default(true) @map("is_available")
  status          ServiceStatus @default(ACTIVE)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  provider        ServiceProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  category        Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  bookings        Booking[]

  @@index([providerId])
  @@index([categoryId])
  @@index([serviceType])
  @@index([status, isAvailable])
  @@map("services")
}


// ===========================================
// Orders Enums
// ===========================================

enum FulfillmentType {
  DELIVERY
  PICKUP
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  PICKED_UP
  DELIVERED
  CANCELLED
}

// ===========================================
// Orders
// ===========================================

model Order {
  id              String          @id @default(uuid())
  orderNumber     String          @unique @map("order_number")
  customerId      String          @map("customer_id")
  vendorId        String          @map("vendor_id")
  driverId        String?         @map("driver_id")
  fulfillmentType FulfillmentType @map("fulfillment_type")
  subtotal        Decimal         @db.Decimal(10, 3) // BHD 3 decimals
  deliveryFee     Decimal?        @map("delivery_fee") @db.Decimal(10, 3) // null if pickup
  commission      Decimal         @db.Decimal(10, 3)
  total           Decimal         @db.Decimal(10, 3)
  status          OrderStatus     @default(PENDING)
  deliveryAddress Json?           @map("delivery_address") // null if pickup
  pickupAddress   Json?           @map("pickup_address") // vendor location if pickup
  notes           String?         @db.Text
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  customer        User            @relation("CustomerOrders", fields: [customerId], references: [id])
  vendor          Vendor          @relation(fields: [vendorId], references: [id])
  driver          User?           @relation("DriverOrders", fields: [driverId], references: [id])
  items           OrderItem[]
  refunds         Refund[]

  @@index([customerId])
  @@index([vendorId])
  @@index([driverId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String   @map("order_id")
  productId   String   @map("product_id")
  // Price snapshot at order time
  productName String   @map("product_name")
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 3)
  quantity    Int
  subtotal    Decimal  @db.Decimal(10, 3) // unit_price Ã— quantity
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ===========================================
// Audit Logs Enums
// ===========================================

enum ActorRole {
  CUSTOMER
  VENDOR
  PROVIDER
  DRIVER
  ADMIN
  SYSTEM
}

// ===========================================
// Audit Logs
// ===========================================

model AuditLog {
  id          String    @id @default(uuid())
  actorId     String?   @map("actor_id")
  actorRole   ActorRole @map("actor_role")
  action      String    // e.g., "order.status_changed", "payment.refunded"
  entityType  String    @map("entity_type") // e.g., "order", "payment", "user"
  entityId    String    @map("entity_id")
  diff        Json?     // Before/after changes
  metadata    Json?     // Additional context
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  actor       User?     @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@index([actorId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ===========================================
// Payment Enums
// ===========================================

enum PayableType {
  ORDER
  BOOKING
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethod {
  CARD
}

enum RefundReason {
  CUSTOMER_REQUEST
  VENDOR_CANCEL
  QUALITY_ISSUE
  DUPLICATE
  OTHER
}

enum RefundStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ===========================================
// Payments
// ===========================================

model Payment {
  id              String        @id @default(uuid())
  transactionId   String        @unique @map("transaction_id")
  idempotencyKey  String        @unique @map("idempotency_key")
  payableType     PayableType   @map("payable_type")
  payableId       String        @map("payable_id")
  amount          Decimal       @db.Decimal(10, 3)
  currency        String        @default("BHD")
  status          PaymentStatus @default(PENDING)
  paymentMethod   PaymentMethod @default(CARD) @map("payment_method")
  gatewayResponse Json?         @map("gateway_response")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  refunds         Refund[]

  @@index([idempotencyKey])
  @@index([payableType, payableId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// ===========================================
// Refunds
// ===========================================

model Refund {
  id            String       @id @default(uuid())
  paymentId     String       @map("payment_id")
  orderId       String?      @map("order_id")
  bookingId     String?      @map("booking_id")
  amount        Decimal      @db.Decimal(10, 3)
  currency      String       @default("BHD")
  reason        RefundReason
  reasonDetails String?      @map("reason_details") @db.Text
  status        RefundStatus @default(PENDING)
  gatewayRef    String?      @map("gateway_ref")
  createdById   String       @map("created_by")
  createdAt     DateTime     @default(now()) @map("created_at")

  // Relations
  payment       Payment      @relation(fields: [paymentId], references: [id])
  order         Order?       @relation(fields: [orderId], references: [id])
  booking       Booking?     @relation("BookingRefunds", fields: [bookingId], references: [id])
  createdBy     User         @relation(fields: [createdById], references: [id])

  @@index([paymentId])
  @@index([orderId])
  @@index([status])
  @@index([createdAt])
  @@map("refunds")
}


// ===========================================
// Booking Enums
// ===========================================

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ===========================================
// Bookings
// ===========================================

model Booking {
  id              String        @id @default(uuid())
  bookingNumber   String        @unique @map("booking_number")
  customerId      String        @map("customer_id")
  providerId      String        @map("provider_id")
  serviceId       String        @map("service_id")
  
  // Scheduling
  scheduledDate   DateTime      @map("scheduled_date") @db.Date
  scheduledTime   DateTime?     @map("scheduled_time") @db.Time(0) // For appointment type
  endTime         DateTime?     @map("end_time") @db.Time(0) // Calculated from duration
  
  // Pricing (snapshot at booking time)
  price           Decimal       @db.Decimal(10, 3) // BHD 3 decimals
  commission      Decimal       @db.Decimal(10, 3)
  total           Decimal       @db.Decimal(10, 3)
  
  // Status and details
  status          BookingStatus @default(PENDING)
  serviceAddress  Json?         @map("service_address") // For home services
  notes           String?       @db.Text
  cancellationReason String?    @map("cancellation_reason") @db.Text
  cancelledAt     DateTime?     @map("cancelled_at")
  cancelledBy     String?       @map("cancelled_by") // user_id who cancelled
  
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  customer        User          @relation("CustomerBookings", fields: [customerId], references: [id])
  provider        ServiceProvider @relation(fields: [providerId], references: [id])
  service         Service       @relation(fields: [serviceId], references: [id])
  refunds         Refund[]      @relation("BookingRefunds")

  @@index([customerId])
  @@index([providerId])
  @@index([serviceId])
  @@index([scheduledDate])
  @@index([status])
  @@index([bookingNumber])
  @@map("bookings")
}
